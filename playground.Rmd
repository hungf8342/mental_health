---
title: "Playground"
author: "Frances Hung"
date: "10/21/2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning=FALSE)
```
## Motivation

According to the CDC, suicide was the 10th leading cause of death in the US in 2015, and the 2nd leading cause of death among adolescents and young adults. Psychological disorders, particularly depression, are a significant risk factor for suicide especially when they go untreated. There is no reliable way to predict who is at risk for committing suicide, because most screening approaches depend on self-report information and people contemplating on suicide would often deny it when asked. However, even if someone wouldn't tell the truth on a questionnaire, they will often tell Google. Using suicide rate and mental health treatment facilities data as well as Google search term data, our project aims to map the demand for and supply of mental health treatment in California cities.

- use result/visualization as hook

## Playground


```{r}
require(gtrendsR)
require(ggplot2)
require(dplyr)
require(ggmap)
require(zipcode)
```

## Making Dataframes

This gives us a master dataframe of search frequencies of “depression” over the past 12 months in the US which relate for sure to mental health. We can take different dataframes using "$": see the dataframe for details.

```{r}
trend<-gtrends("suicide",c("US"),time="today+5-y")
trend$interest_by_region
```

For example, this gives us search frequencies by cities in CA in the U.S.

```{r}
cities_longlat<-read.csv("cal_cities.csv",header=TRUE) %>% select(c(location,Latitude,Longitude))
cities_dep<-gtrends("depression",c("US-CA"),time="today 12-m")$interest_by_city
cities_dep<-cities_dep %>% inner_join(cities_longlat,by="location")

write.csv(cities_dep,file="cities_top49.csv")
```

This plots cities_dep.

```{r}
ggplot(cities_dep,aes(x=reorder(location,hits),y=hits))+geom_bar(stat="identity")+theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r}

for (i in 1:length(cities_dep$location)) {
  place=geocode(cities_dep$location[i],output="latlon",source="dsk")
  cities_dep$lat[i]=as.numeric(place[1])
  cities_dep$lon[i]=as.numeric(place[2])
}
cities_dep$keyword<-NULL
cities_dep$geo<-NULL
cities_dep$gprop<-NULL
```

```{r}
center=as.numeric(geocode("United States",source="dsk"))
mappy<-get_map(c(-119.4179,36.7783),zoom=6,scale=2,maptype = "terrain",source="google")
p=ggmap(mappy,extent="device",ylab="Latitude",xlab="Longitude")
p=p+geom_point(data=cities_dep,aes(x=lat,y=lon),size=(cities_dep$hits/50)^2)
p
```


```{r}
suis<-read.csv(file="death.csv",header=TRUE) %>% filter(Causes.of.Death=="SUI") #%>% filter(Year >= 2010)
colnames(suis)[2]<-"zip"
suis$zip<-as.character(suis$zip)
city_suis<-inner_join(zipcode,suis,by="zip") 
city_suis<-city_suis %>% group_by(city) %>% summarise(suicides=sum(Count))
colnames(city_suis)[1]<-"location"
```

```{r}
citydem<-read.csv("citydems.csv",header=TRUE)
citydem2<-read.csv("citydems2.csv",header=TRUE)
citydem2$Name<-gsub(",.*","",citydem2$Name)
citydem$Name<-gsub(",.*","",citydem$Name)
citydem$FIPS<-NULL
citydem2$FIPS<-NULL
colnames(citydem)<-c("location", "male", "female","healthcare","bluecollar","whitecollar","nonfamily","medAge","AmInd", "whiteNonHisp","hisp","white","black","asian","medIncome","lessHS","HS","Bachelors","pop","unmarriedMpop","unemployed")
colnames(citydem2)<-c("location","healthcarepp","activities","socialRec","entertainment","pov","presdrugs","healthcarebiz")
logtable<-inner_join(citydem,cities_dep,by="location") %>% inner_join(city_suis,by="location") %>% inner_join(citydem2,by="location") %>% mutate(suicides=suicides*10000/pop,healthcarepp=healthcarepp/pop,activities=activities/pop,socialRec=socialRec/pop,entertainment=entertainment/pop,presdrugs=presdrugs/pop,healthcarebiz=healthcarebiz*1000/pop)
#logtable$hiRate<- ifelse(logtable$suicides>median(logtable$suicides),1,0)
logtable_crop<-logtable[,-c(1,23,24)]
```

```{r}
set.seed(1)
model<-lm(log(suicides)~.,data=logtable_crop)
summary(model)
```
Variables significant in this regression are poverty rate (+), density of healthcare businesses(+), and black/Asian population percentwise (-) in the city. Variables which also should be considered according to this regression are percentage of white-collar workers (-), searches of "depression" (+), median income (+), hispanice population (-), and white non-Hispanic population (-). 
```{r}
ggplot(logtable_crop,aes(x=asian,y=log(suicides)))+geom_point()
```


```{r}
library(caret)
modelrf<-train(suicides~.,method="rf",tuneGrid=data.frame(mtry=c(2,3,4,5,6)),data=logtable_crop)
modelrf$finalModel

```

facilities data
```{r}
facilities <- read_csv("filtered_licensed-healthcare-facility-listing-june-30-2017.csv")
facilities <- filter(facilities, LICENSE_CATEGORY_DESC == "Acute Psychiatric Hospital"|LICENSE_CATEGORY_DESC == "Psychiatric Health Facility" | LICENSE_CATEGORY_DESC =="Psychology Clinic")
View(facilities)
write.csv(facilities, file="facilities.csv")
# more facilities
facilities.2 <- read_csv("facilities.csv")
View(facilities.2)
write.csv(facilities.2, file = "facilities_2.csv")
```


